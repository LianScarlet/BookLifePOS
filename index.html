<!DOCTYPE html>
<html>
<head>
  <title>BookLife POS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <!-- 系統必要的 CSS -->
  <link rel="stylesheet" href="font-awesome-4.1.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="bootstrap-3.2.0-dist/css/bootstrap.min.css">  
  <link rel="stylesheet" href="bootstrap-3.2.0-dist/css/bootstrap-theme.css"> 
  <!-- 系統必要的 js 檔案 -->
  <script src="js/jquery-1.11.1.min.js"></script>
  <script src="bootstrap-3.2.0-dist/js/bootstrap.min.js"></script> 
  <link rel="stylesheet" href="css/style.css">
  <script type="text/javascript">
    var detail_list = [];
    var detail_index=0;
    var detailapiP1="http://10.10.59.238:8080/"
    var detailapiP2="?v=view_cbookcase&cid=20166307&";
    var searchapi="";
    var data;
    var input_temp;



    $(function(){
      /*$( "#input_search" ).keypup(function(data) { 
        if(data.keyCode==13)
        {
          checktype();
        }
        if( $("#input_search").val() != "" && $("#input_search").val() != input_temp )
        {

        }
      });*/
//document.getElementById("complete").onclick=dealcomplete;
$("#search").click(checktype);
$("#complete").click(dealcomplete);
//$('.typeahead').typeahead(source);


});

    function checktype()
    {
      $("#resultinfo").empty();
      var searchtxt = $("#input_search").val();
      if(searchtxt=="")
      {
        $("#resultinfo").empty();
        $("#resultinfo").append("<h4 class=\"content-tmplate\"> 請輸入 ISBN 或 書名 </h4>")
      }else{
        if($.isNumeric(searchtxt) && (searchtxt.length == 13 || searchtxt.length == 10))
        {
          searchapi= detailapiP1 + "datafeedjson.ashx" + detailapiP2 + 'ISBN=' + searchtxt;
        }
        else
        {
          searchapi= detailapiP1 + "datafeedjson2.ashx" + detailapiP2 + 'Title=' + searchtxt;
        }
        searchresult();
      }
    }

    function searchresult()
    {

      $("#resultinfo").empty();
      $.getJSON(searchapi, function(jstr) {
        if(jstr.item.length == 1){
    $.each(jstr.item, function(i, o) { // index, object
      $("#resultinfo").append("<div style=\"border:1px solid; padding:0px 15px;\" class=\"content-tmplate\"><h3 id=\"title\">"+o.Title+"</h3><p>"+o.ISBN+"<br/>"+o.Author+"<br/>"+o.Publisher+"<br/>"+o.PDate+"</p></div>"+"<label for=\"price\">售價 : </label><input type=\"text\" name=\"price\" id=\"price\" autofocus><br/><label for=\"amount\">數量 : </label><input type=\"text\" name=\"amount\" id=\"amount\" value=\"1\"><br/><button href=\"#\" type=\"button\" class=\" btn btn-default \" id=\"ok\" onclick=\"adddetail()\">OK</button>");
    });
  }else if(jstr.item.length > 1){
    $("#resultinfo").append("<p> Resuult > 1 </p><button href=\"#\" type=\"button\" class=\" btn btn-default\"  id=\"ok\" onclick=\"adddetail()\">OK</button>");
  }else{
    $("#resultinfo").append("<p class=\"content-tmplate\"> No Result </p>")
  }
})
document.getElementById("input_search").value = "";

}

function adddetail()
{
  var btitle = $("#title").text();
  var bprice = $("#price").val();
  var bamount = $("#amount").val();
  if($.isNumeric(bprice) && $.isNumeric(bamount))
  {
    detail_list[detail_list.length]="<tr><td></td><td>" + btitle +"</td><td id=\"price"+detail_list.length+"\">"+bprice+"</td><td id=\"amount"+detail_list.length+"\">"+bamount+"</td></tr>";
  }else
  {
    alert("格式輸入錯誤");
  }
  showdetail();

}
function deldetail(index){
  detail_list.splice(index,1);
  showdetail();
}
function showdetail(){
  $("#detailtable").empty();
  $("#detailtable").append("<tr>-1</tr>");
  for(var i=detail_list.length-1;i>=0;i--)      
    $("#detailtable").append(detail_list[i]);
  totalcost();
}

function totalcost(){
  var total = 0;
  var price = 0;
  var amount = 0;
    //alert(document.getElementById("price0").value);
    for(var i=0;i<detail_list.length;i++)
    {
      price = document.getElementById("price"+i).textContent;
      amount = document.getElementById("amount"+i).textContent;
      total += price * amount;
    }
    document.getElementById("totalprice").innerHTML = 'NT$　' + total;
  }

  function dealcomplete(){
    $("#detailtable").empty();
    $("#detailtable").append("<tr></tr>");
    detail_list = [];
    totalcost();
    document.getElementById("input_search").value = "";
  }



</script>
</head>

<body>
  <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
        </button>
        <a class="navbar-brand" href="#">BookLife POS v1.0</a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li class="active"><a href="#">Home</a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <li><a href="#login">Login</a></li>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </div>

  <div class="container">
    <div class="row">
      <div class="col-md-2 starter-template bgc">
      </div>
      <div class="col-md-4 starter-template bgc">
        <div>
          <table class="table" >
            <thead>
              <th colspan="3"><input type="text" class=" input-medium search-query" id="input_search" placeholder="ISBN or Title" data-provide="typeahead" autofocus></th>
              <th><button class=" btn btn-default" id="search"><i class="fa fa-search" ></i></button></th>
            </thead>
            <tbody >
              <tr>
                <th colspan="2">消費總金額</th>
                <th id="totalprice" >$0</th>
                <th><button class="btn btn-default" id="complete">Complete</button></th>
              </tr>
              <tr>
                <th>刪除</th>
                <th>商品名稱</th>
                <th>售價</th>
                <th>數量</th>
              </tr>
            </tbody>
            <tfoot id="detailtable">
            </tfoot>
          </table>
        </div>
      </div>
      <div class="col-md-4 starter-template bgc" id="resultinfo">
      </div>
      <div class="col-md-2 starter-template bgc">
      </div>
    </div>



  </div>
</div><!-- /.container -->



</body>
</html>