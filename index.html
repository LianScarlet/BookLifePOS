<!DOCTYPE html>
<html>
<head>
  <title>BookLife POS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <!-- 系統必要的 CSS -->
  <link rel="stylesheet" href="font-awesome-4.1.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="bootstrap-3.2.0-dist/css/bootstrap.min.css">  
  <link rel="stylesheet" href="bootstrap-3.2.0-dist/css/bootstrap-theme.css"> 
  <!-- 系統必要的 js 檔案 -->
  <script src="js/jquery-1.11.1.min.js"></script>
  <script src="bootstrap-3.2.0-dist/js/bootstrap.js"></script> 
  <script src="js/bootstrap-typeahead.js"></script>
  <link rel="stylesheet" href="css/style.css">
  <script type="text/javascript">
    var detail_list = [];
    var detail_index=0;
    var cid = "20166307";
    var detailapiP1="http://10.10.59.238:8080/"
    var detailapiP2="?v=view_cbookcase&cid=" + cid + "&";
    var searchapi="";
    var searchdata="";
    var mySource = [];
    var input_temp ="";



    $(function(){
      $( "#input_search" ).keyup(function(data) {
        var ele = $(this);
        var inputval = ele.val();

        if( inputval != "" && inputval != input_temp )
        {

          searchapi= detailapiP1 + "datafeedjson2.ashx" + detailapiP2 + 'Title=' + inputval;
          $.getJSON(searchapi, function(jstr) {
            // appen data to input element
            searchdata = jstr;
            appenData(ele,jstr);            
          });  
        }

        var splitsearch = inputval.split(',');
        if(data.keyCode==13 && (splitsearch[2] != undefined || inputval.length == 13 || inputval.length == 10))
        {
          searchresult();
        }  

        input_temp = inputval;

        $("#search").click(searchresult);
        $("#complete").click(dealcomplete);

        //搜尋結果
        function searchresult(){

          var splitsearch = $('#input_search').val().split(',');

          if(splitsearch[2] != undefined){

            $("#resultinfo").empty();

            $.each(searchdata.item, function(i, o) {

              if(o.OID == splitsearch[2]){
               $("#resultinfo").append("<div style=\"border:1px solid; padding:0px 15px;\" class=\"content-tmplate\"><h3 id=\"title\">"+o.Title+"</h3><p>"+o.ISBN+"<br/>"+o.Author+"<br/>"+o.Publisher+"<br/>"+o.PDate+"</p></div>");


               var lab_price = $('<label>').attr('for', 'price').text('售價'),
               inp_price = $('<input>').attr({
                name: 'price',
                id: 'price' }).focus(),
               lab_amount= $('<label>').attr('for', 'amount').text('數量'),
               inp_amount = $('<input>').attr({
                name: 'amount',
                id: 'amount',
                value: '1' }),
               btn_ok = $('<button>').attr({
                href: '#',
                id: 'ok'
              }).addClass('btn btn-default').text('OK');

               $("#resultinfo").append(lab_price).append(inp_price).append('<br>')
               .append(lab_amount).append(inp_amount).append('<br>').append(btn_ok);


               inp_price.on('keyup', function(event) {
                 if(event.keyCode==13)inp_amount.focus();  
               });

               inp_amount.on('keyup', function(event) {
                 if(event.keyCode==13)btn_ok.focus();  
               });

               btn_ok.on('click', function(event) {
                 adddetail(o.OID);  
               });
             }
           }); 


$('#price').focus();
}else{

  $("#resultinfo").empty();
  var searchtxt = $("#input_search").val();

  if(searchtxt=="")
  {
    $("#resultinfo").empty();
    $("#resultinfo").append("<h4 class=\"content-tmplate\"> 請輸入 ISBN 或 書名 </h4>");

  }else{

    searchapi= detailapiP1 + "datafeedjson.ashx" + detailapiP2 + 'ISBN=' + searchtxt;

    $.getJSON(searchapi, function(jstr) {
      if(jstr.item.length == 1){


        $("#resultinfo").append("<div style=\"border:1px solid; padding:0px 15px;\" class=\"content-tmplate\"><h3 id=\"title\">"+jstr.item[0].Title+"</h3><p>"+jstr.item[0].ISBN+"<br/>"+jstr.item[0].Author+"<br/>"+jstr.item[0].Publisher+"<br/>"+jstr.item[0].PDate+"</p></div>");


        var lab_price = $('<label>').attr('for', 'price').text('售價'),
        inp_price = $('<input>').attr({
          name: 'price',
          id: 'price' }).focus(),
        lab_amount= $('<label>').attr('for', 'amount').text('數量'),
        inp_amount = $('<input>').attr({
          name: 'amount',
          id: 'amount' ,
          value: '1'}),
        btn_ok = $('<button>').attr({
          href: '#',
          id: 'ok'
        }).addClass('btn btn-default').text('OK');

        $("#resultinfo").append(lab_price).append(inp_price).append('<br>')
        .append(lab_amount).append(inp_amount).append('<br>').append(btn_ok);


        btn_ok.click(adddetail(jstr.item[0].OID));

        inp_price.on('keyup', function(event) {
         if(event.keyCode==13)inp_amount.focus();  
       });

        inp_amount.on('keyup', function(event) {
         if(event.keyCode==13)btn_ok.focus();  
       });
        btn_ok.on('click', function(event) {
         adddetail(jstr.item[0].OID);  
       });

      }else{
        $("#resultinfo").append("<h3 class=\"content-tmplate\"> No Result </h3>");
      }
    });
}
}
$('#input_search').val('');
}
});


//auto complete
function appenData (ele,data){
  console.log(ele,data);
  mySource = [] ;
  for(var i=0;i<data.item.length;i++)
    mySource.push( { id : data.item[i].OID, name : data.item[i].Title + "," + data.item[i].Publisher + "," + data.item[i].OID});
  console.log(mySource);
  ele.typeahead().data('typeahead').source=mySource;
  ele.typeahead({ source: mySource}).data('typeahead').lookup();
}
});


function adddetail(oid){
  var btitle = $("#title").text();
  var bprice = $("#price").val();
  var bamount = $("#amount").val();

  if($.isNumeric(bprice) && $.isNumeric(bamount))
  {

    detail_list.push({ OID : oid, Title : btitle, Price : bprice, Amount : bamount});
    $("#resultinfo").empty();
    $('#input_search').focus();

  }else{
   if($('#price').val() == "")
   {
    $('#price').focus();
  }else{
    $('#amount').focus();
  }
}
showdetail();
}

function deldetail(index){
  //alert();
  for(var i=0; i <detail_list.length; i++)
  {
    if ( index == detail_list[i].OID ){
      detail_list.splice(i,1);
      break;
    }
  }
  //detail_list.splice(index,1);
  showdetail();

}
function showdetail(){
  $("#detailtable").empty();
  $("#detailtable").append("<tr></tr>");
  for(var i=detail_list.length-1;i>=0;i--){      


    var td_del = $('<td>').html("<button onclick=\"+ deldetail("+ detail_list[i].OID +") \"><i class=\"fa fa-times\"></i></button>");
    var td_title = $('<td>').text(detail_list[i].Title);
    var td_price = $('<td>').attr({
      id: 'price' + i }).text(detail_list[i].Price);
    var td_amount = $('<td>').attr({
      id: 'amount' + i }).text(detail_list[i].Amount);
    //console.log(td_price.id);
    $("#detailtable").append("<tr>").append(td_del).append(td_title).append(td_price).append(td_amount).append("</tr>");
  }
  totalcost();
}

function totalcost(){

  var total = 0;
  var price = 0;
  var amount = 0;

  for(var i=0;i<detail_list.length;i++)
  {
    price = document.getElementById("price"+i).textContent;
    amount = document.getElementById("amount"+i).textContent;
    total += price * amount;
  }
  document.getElementById("totalprice").innerHTML = 'NT$　' + total;
}

function dealcomplete(){
  $("#detailtable").empty();
  $("#detailtable").append("<tr></tr>");
  detail_list = [];
  totalcost();
  $('#input_search').val('');;
}



</script>
</head>

<body>
  <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
        </button>
        <a class="navbar-brand" href="#">BookLife POS v1.0</a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li class="active"><a href="#">Home</a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <li><a href="#login">Login</a></li>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </div>

  <div class="container">
    <div class="row">
      <div class="col-md-offset-1 col-md-5 starter-template bgc">
        <div>
          <table class="table book-template" >
            <thead>
              <th colspan="3">
                <input type="text" class=" input-medium search-query" id="input_search" placeholder="請輸入[ISBN]或[完整書名]" data-provide="typeahead" autofocus >
              </th>
              <th><button class=" btn btn-default" id="search"><i class="fa fa-search" ></i></button></th>
            </thead>
            <tbody >
              <tr>
                <th colspan="2">消費總金額</th>
                <th id="totalprice" >$0</th>
                <th><button class="btn btn-warning" id="complete">結帳</button></th>
              </tr>
              <tr>
                <th>刪除</th>
                <th>商品名稱</th>
                <th>售價</th>
                <th>數量</th>
              </tr>
            </tbody>
            <tfoot id="detailtable">
            </tfoot>
          </table>
        </div>
      </div>
      <div class="col-md-5 starter-template bgc" >
        <div class="book-template" id="resultinfo">
        </div>
      </div>
    </div>
  </div>
</div><!-- /.container -->
</body>
</html>